# /code-review

*执行专注的多代理代码审查，仅 surfaced 对使用 AI 工具的独立开发者具有关键性、高影响力的发现。*

## 核心理念

此命令优先考虑**具有变革性的发现**，而非详尽的列表。每个发现必须证明对以下方面具有重大影响：
- 系统可靠性和稳定性
- 具有真实利用风险的安全漏洞
- 影响用户体验的性能瓶颈
- 阻碍未来可扩展性的架构决策
- 威胁可维护性的关键技术债务

### 🚨 仅限关键发现
可能在 48 小时内导致生产故障、安全漏洞或严重用户影响的问题。

### 🔥 高价值改进
解锁新功能、移除重要约束或将指标提升 >25% 的变更。

### ❌ 报告中排除
次要风格问题、微优化（<10%）、理论最佳实践、影响 <1% 用户的边缘情况。


## 自动加载项目上下文：
@/CLAUDE.md
@/docs/ai-context/project-structure.md
@/docs/ai-context/docs-overview.md


## 命令执行

用户提供的上下文："$ARGUMENTS"

### 第 1 步：理解用户意图并收集上下文

#### 解析请求
分析自然语言输入以确定：
1. **审查内容**：解析文件路径、组件名称、功能描述或提交引用
2. **审查重点**：识别提到的任何特定关注点（安全性、性能等）
3. **范围推断**：智能确定所需审查的广度

意图解析示例：
- "身份验证流程" → 查找整个代码库中与身份验证相关的所有文件
- "语音管道实现" → 定位语音处理组件
- "最近的更改" → 解析相关提交的 git 历史
- "API 路由" → 识别所有 API 端点文件

#### 阅读相关文档
在分配代理之前，**阅读文档**以了解：
1. 使用 `/docs/ai-context/docs-overview.md` 识别相关文档
2. 阅读与被审查代码相关的文档：
   - 子系统理解的架构文档
   - 集成点的 API 文档
   - 敏感区域的安全指南
   - 关键路径的性能考虑
3. 建立风险、约束和优先级的心智模型

此上下文确保基于实际项目知识进行智能代理分配。

### 第 2 步：定义强制覆盖区域

每个代码审查必须分析这些核心区域，深度由范围决定：

#### 🎯 强制覆盖区域：

1. **关键路径分析**
   - 可能损坏的用户面向功能
   - 数据完整性和状态管理
   - 错误处理和恢复机制

2. **安全表面**
   - 输入验证和清理
   - 身份验证/授权流程
   - 数据暴露和 API 安全

3. **性能影响**
   - 实时处理瓶颈
   - 资源消耗（内存、CPU）
   - 可扩展性约束

4. **集成点**
   - API 契约和边界
   - 服务依赖
   - 外部系统交互

#### 📊 动态代理分配：

根据审查范围，按比例分配代理：

**小到中等范围（小文件集或小功能）**
- 2-3 个代理覆盖强制区域
- 每个代理处理 1-2 个覆盖区域
- 专注于最高风险方面

**大范围（多文件、主要功能或子系统）**
- 4-6 个具有专业化重点的代理
- 每个强制区域获得专门覆盖
- 跨域关注点的额外代理

### 第 3 步：动态代理生成

基于范围分析和强制覆盖区域，动态创建专业化代理：

#### 代理生成策略：

**利用您在第 1 步中的文档知识，深入思考**最佳代理分配：
- 利用您对项目架构和风险的理解
- 考虑您阅读的关于此子系统的特定文档
- 应用关键路径和安全考虑的洞察
- 使用文档化的边界和集成点划分工作
- 考虑文档中的性能或可扩展性关注

使用您对项目的理解直观确定：
1. **需要多少代理** - 让代码的复杂性和关键性指导您
2. **如何划分工作** - 遵循自然架构边界
3. **哪些专业化最重要** - 将代理集中在风险最高的地方

**生成专业化代理**

   对于每个分配的代理，创建专注的角色：

   **6 个代理分配示例：**
   - 代理 1：Critical_Path_Validator（用户流程 + 错误处理）
   - 代理 2：Security_Scanner（输入验证 + 身份验证）
   - 代理 3：API_Security_Auditor（数据暴露 + 边界）
   - 代理 4：Performance_Profiler（瓶颈 + 资源使用）
   - 代理 5：Scalability_Analyst（约束 + 增长路径）
   - 代理 6：Integration_Verifier（依赖 + 契约）

   **3 个代理分配示例：**
   - 代理 1：Security_Performance_Analyst（安全 + 性能区域）
   - 代理 2：Critical_Path_Guardian（功能 + 集成）
   - 代理 3：Risk_Quality_Assessor（技术债务 + 代码质量）

#### 动态重点区域：

每个代理根据以下内容接收专业化指令：
- **文件特征**：API 端点 → 安全重点
- **代码模式**：循环/算法 → 性能重点
- **依赖**：外部服务 → 集成重点
- **用户触点**：UI/语音 → 关键路径重点

### 第 4 步：执行动态多代理审查

**在启动代理之前，暂停并深入思考：**
- 这段代码中的真正风险是什么？
- 哪些区域如果失败会造成最大损害？
- 独立开发者在哪些方面最需要帮助？

基于您的深思熟虑分析生成和启动代理：

```
对于每个动态生成的代理：
  任务："作为 [Agent_Role]，分析 [target_scope] 中的 [assigned_coverage_areas]。

  强制覆盖检查清单：
  ☐ 关键路径：[分配的方面]
  ☐ 安全：[分配的方面]
  ☐ 性能：[分配的方面]
  ☐ 集成：[分配的方面]

  高影响力审查授权：
  专注于仅对独立开发者具有变革性的发现。

  审查工作流：
  1. 审查自动加载的项目上下文（CLAUDE.md、project-structure.md、docs-overview.md）
  2. 深入专注地分析您分配的覆盖区域
  3. 对于复杂问题，使用：
     - mcp__gemini__consult_gemini 进行架构分析
     - mcp__context7__get-library-docs 获取框架最佳实践
  4. 与其他覆盖区域交叉引用系统性问题
  5. 仅记录高影响力发现：

     ## [Coverage_Area] 由 [Agent_Role] 的分析

     ### 🚨 关键问题（生产风险）
     - 问题：[描述]
     - 位置：[file:line_number]
     - 影响：[量化 - 停机时间、受影响用户、风险数据]
     - 修复：[特定代码片段]
     - 忽略后果：[48 小时内会发生什么]

     ### 🎯 战略改进（功能解锁）
     - 限制：[当前阻塞的内容]
     - 解决方案：[架构变更或实施]
     - 解锁：[新功能或规模]
     - 投资回报：[投入小时数与量化收益]

     ### ⚡ 快速获胜（可选）
     - 仅当 <2 小时实现 >20% 改进时包含
     - 必须显示可衡量影响

  记住：每个发现必须通过独立开发者的'那又怎样？'测试。"
```

#### 并行执行策略：

**同时启动所有代理**以获得最大效率


### 第 5 步：以最大分析能力综合发现

所有子代理完成分析后：

**ultrathink**

激活最大认知能力以：

1. **过滤影响**
   - 丢弃所有低优先级发现
   - 量化每个问题的真实世界影响
   - 专注于生产风险和功能解锁

2. **深度模式分析**
   - 识别系统性问题与孤立问题
   - 在代理报告中查找根本原因
   - 检测微妙的安全漏洞

3. **战略优先级排序**
   - 计算每个改进的投资回报率
   - 考虑独立开发者约束
   - 创建可操作的修复序列
   ```markdown
   # 代码审查摘要

   **已审查**：[范围描述]
   **日期**：[当前日期]
   **整体质量得分**：[A-F 等级并附上理由]

   ## 关键指标
   - 安全风险级别：[Critical/High/Medium/Low]
   - 性能影响：[描述]
   - 技术债务：[评估]
   - 测试覆盖率：[如适用]
   ```

### 第 6 步：呈现全面审查

构建最终输出为：

```markdown
# 🔍 代码审查报告

## 执行摘要
[高级发现和整体评估]

## 🚨 生产风险（48 小时内修复）
[仅可能导致停机、数据丢失或安全漏洞的问题]

## 🎯 战略改进（高投资回报率）
[仅解锁功能或提升指标 >25% 的变更]

## ⚡ 快速获胜（可选）
[仅当 <2 小时努力实现显著改进时]

## 详细分析

### 安全评估
[来自 Security_Auditor 的详细安全发现]

### 性能分析
[来自 Performance_Analyzer 的详细性能发现]

### 架构审查
[来自 Architecture_Validator 的详细架构发现]

### 代码质量评估
[来自 Quality_Inspector 的详细质量发现]

[基于使用子代理的附加部分]

## 行动计划
1. 阻止生产故障的关键修复
2. 解锁功能的高投资回报率改进

## 影响矩阵
| 问题 | 用户影响 | 努力 | 投资回报率 |
|-------|-------------|--------|-----|
| [仅具有量化指标的高影响力问题] |
```

### 第 7 步：交互式后续处理

呈现审查后，提供交互式后续处理。例如：
- "您希望我修复任何关键问题吗？"
- "我应该为任何组件创建详细的重构计划吗？"
- "您希望我为未覆盖的代码生成测试吗？"
- "我应该为跟踪这些改进创建 GitHub 问题吗？"

## 实施说明

1. **为所有子代理使用并行任务执行**以最小化审查时间
2. **包含 file:line_number 引用**以便于导航
3. **平衡批评与认可**良好实践
4. **提供可操作的修复**，而不仅仅是问题识别
5. **考虑项目阶段**和优先级时推荐变更
6. **有益时使用 MCP 服务器**进行专业化分析
7. **保持安全发现敏感** - 不要公开暴露漏洞

## 错误处理

### 覆盖验证

在呈现结果之前，验证完整覆盖：

```
☑ 关键路径分析：[由代理 X, Y 覆盖]
☑ 安全表面：[由代理 Y, Z 覆盖]
☑ 性能影响：[由代理 X, Z 覆盖]
☑ 集成点：[由代理 W, X 覆盖]
```

如果任何区域缺乏覆盖，部署额外的专注代理。

## 错误处理

审查期间发生问题时：
- **输入模糊**：在要求澄清之前使用搜索工具查找相关文件
- **文件未找到**：在整个代码库中搜索相似名称或组件
- **检测到大范围**：根据计算复杂度动态扩展代理
- **未找到文件**：基于项目结构提供有用建议
- **覆盖缺口**：为缺失区域部署补充代理